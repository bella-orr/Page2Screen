# Builds the Docker image for the Spring Boot app and deploys it to Azure Web App for Containers.
name: Deploy to Azure Web App

on:
  push:
    branches: ["main"]

env:
  RESOURCE_GROUP: Page2Screen_group               # existing RG from portal deployment
  WEBAPP_NAME: page2screen-webapp                 # update to your Web App name
  ACR_LOGIN_SERVER: yourregistry.azurecr.io       # e.g. myacr.azurecr.io
  IMAGE_NAME: page2screen                         # repo name in ACR

jobs:
  build-and-deploy:
    runs-on: ubuntu-latest
    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Azure login
        uses: azure/login@v2
        with:
          client-id: ${{ secrets.AZURE_CLIENT_ID }}
          tenant-id: ${{ secrets.AZURE_TENANT_ID }}
          subscription-id: ${{ secrets.AZURE_SUBSCRIPTION_ID }}

      - name: Docker login to ACR
        uses: docker/login-action@v3
        with:
          registry: ${{ env.ACR_LOGIN_SERVER }}
          username: ${{ secrets.ACR_USERNAME }}
          password: ${{ secrets.ACR_PASSWORD }}

      - name: Build and push image
        env:
          IMAGE_TAG: ${{ github.sha }}
        run: |
          set -e
          docker build -t $ACR_LOGIN_SERVER/$IMAGE_NAME:$IMAGE_TAG -t $ACR_LOGIN_SERVER/$IMAGE_NAME:latest .
          docker push $ACR_LOGIN_SERVER/$IMAGE_NAME:$IMAGE_TAG
          docker push $ACR_LOGIN_SERVER/$IMAGE_NAME:latest

      - name: Configure app settings
        run: |
          az webapp config appsettings set \
            --resource-group $RESOURCE_GROUP \
            --name $WEBAPP_NAME \
            --settings \
              SPRING_DATASOURCE_URL='${{ secrets.SPRING_DATASOURCE_URL }}' \
              SPRING_DATASOURCE_USERNAME='${{ secrets.SPRING_DATASOURCE_USERNAME }}' \
              SPRING_DATASOURCE_PASSWORD='${{ secrets.SPRING_DATASOURCE_PASSWORD }}' \
              SPRING_PROFILES_ACTIVE=prod

      - name: Deploy container to Web App
        env:
          IMAGE_TAG: ${{ github.sha }}
        run: |
          az webapp config container set \
            --resource-group $RESOURCE_GROUP \
            --name $WEBAPP_NAME \
            --docker-custom-image-name $ACR_LOGIN_SERVER/$IMAGE_NAME:$IMAGE_TAG \
            --docker-registry-server-url https://$ACR_LOGIN_SERVER \
            --docker-registry-server-user ${{ secrets.ACR_USERNAME }} \
            --docker-registry-server-password ${{ secrets.ACR_PASSWORD }}
          az webapp restart --resource-group $RESOURCE_GROUP --name $WEBAPP_NAME
